#!/bin/bash

target="i386-s2e-softmmu"
bundle_path=$(pwd)

s2e_src_path=""
s2e_build_path=""
llvm_build_path=""
show_help="yes"

for opt do
  optarg=`expr "x$opt" : 'x[^=]*=\(.*\)'`
  case "$opt" in
  --help|-h) show_help="yes"
  ;;
  --s2e-src-path=*) s2e_src_path=`readlink -e "$optarg"`; show_help="no"
  ;;
  --s2e-build-path=*) s2e_build_path=`readlink -e "$optarg"`; show_help="no"
  ;;
  --llvm_build_path=*) llvm_build_path=`readlink -e "$optarg"`; show_help="no"
  ;;
  *) echo "ERROR: unknown option $opt"; show_help="yes"
  ;;
  esac
done

if test x"$show_help" = x"yes" ; then
cat << EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]

EOF
echo "Standard options:"
echo "  --help                  print this message"
echo "  --s2e-src-path=PATH       path to S2E source(must be specified)"
echo "  --s2e-build-path=PATH       path to S2E build (must be specified)"
echo "  --llvm_build_path=PATH       path to LLVM build (must be specified)"
echo ""
echo "Advanced options (experts only):"
echo ""
exit 1
fi

if [[ ! $s2e_src_path ]] ; then
  echo
  echo "ERROR: Path to S2E src does not exist. Please double check"
  exit
fi
if [[ ! $s2e_build_path ]] ; then
  echo
  echo "ERROR: Path to S2E build does not exist. Please double check"
  exit
fi
if [[ ! $llvm_build_path ]] ; then
  echo
  echo "ERROR: Path to LLVM build does not exist. Please double check"
  exit
fi
# Print info 
echo bundle path: $bundle_path
echo S2E src path: $s2e_src_path
echo S2E build  path: $s2e_build_path
echo LLVM build  path: $llvm_build_path

config_h="config.h"
config_mak="config-bundle.mak"
test -f $config_h && mv $config_h ${config_h}~
echo "# Automatically generated by configure - do not modify" > $config_mak

echo "TARGET_DIR=$target" >> $config_mak
echo "S2E_SRC_PATH=$s2e_src_path" >> $config_mak
echo "S2E_BUILD_PATH=$s2e_build_path" >> $config_mak
echo "LLVM_BUILD_PATH=$llvm_build_path" >> $config_mak
echo "BUNDLE_NAME=simplebundle" >> $config_mak

echo "#define S2E_SRC_HOME \"$s2e_src_path\"" >> $config_h
echo "#define S2E_BUILD_HOME \"$s2e_build_path\"" >> $config_h
echo "#define LLVM_BUILD_HOME \"$llvm_build_path\"" >> $config_h
echo "#define BUNDLE_PATH \"$bundle_path\"" >> $config_h
